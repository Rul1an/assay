# Evidence bundle fixtures (normative)

> **Freeze (v1 Contract):** This file is part of the normative Evidence Contract v1 freeze. Do not modify it without updating [EVIDENCE-CONTRACT-v1](../../../docs/spec/EVIDENCE-CONTRACT-v1.md) and following the spec’s versioning and deprecation policy. Intentional changes require a spec/ADR and migration notes where applicable.

These fixtures are the **normative compliance target** for Evidence Contract v1. See [EVIDENCE-CONTRACT-v1](../../../docs/spec/EVIDENCE-CONTRACT-v1.md) for the full contract (compatibility matrix, evolution rules, golden fixture policy).

**Container golden vs event golden:** *Container golden* = tar layout, manifest schema, file hashes, entry ordering. *Event golden* = CloudEvents envelope + payload semantics (required attributes, types, content hashes). Fixtures can target one or both; the spec defines both as part of the contract.

**Determinism goldens vs smoke goldens (do not conflate):**
- **Determinism goldens (pinned hashes):** The pinned hashes live in `crates/assay-evidence/tests/determinism_test.rs`, test `test_golden_hash`. That test *generates its own bundle in memory* (fixed event type and payload). The pinned values are for that generated bundle, **not** for the file `test-bundle.tar.gz`.
- **Smoke goldens (file fixtures):** `test-bundle.tar.gz` is a file fixture used to smoke-test layout, verify, lint, and explore. It is built by `generate_fixture` (different events). Regenerating `test-bundle.tar.gz` does **not** change the determinism_test pinned hashes; update those only when the writer or event *format* changes.

## Bundle list

| Fixture | Purpose | Determinism | Used by |
|---------|---------|-------------|---------|
| **test-bundle.tar.gz** | Smoke: layout, verify, lint, explore | Generated by `generate_fixture` (see below) | CI (action-v2-test, action-tests), `verify_strict_test`, lint tests |
| **minimal** | Single event, single type | In-memory in tests | `verify_strict_test`, lint tests, `create_golden_bundle` |
| **unknown optional fields** | Event with extra optional fields; enforces compat | Normative | **Contract:** verify MUST accept event with extra unknown top-level and payload keys. A conformance test MUST exist; a dedicated on-disk fixture file is OPTIONAL. Enforced by `verify_strict_test::test_verify_accepts_unknown_optional_fields`. |
| **invalid** | Fail-closed: bad digest, malformed JSON, duplicate keys | In-memory / test constructs | `bundle_security_test`, `verify_strict_test`, `payload_type_confusion_test` |

## Regenerating test-bundle.tar.gz (reproducible-by-default)

- **Command (from workspace root):**
  `cargo test -p assay-evidence --test generate_fixture -- --ignored --nocapture`
- **Toolchain:** Use the same Rust version and crate features as CI (see `rust-toolchain.toml` or CI workflow).
- **Pinned hashes (exact location):** `crates/assay-evidence/tests/determinism_test.rs`, test `test_golden_hash`. These pins apply to the *in-memory* bundle generated in that test, not to `test-bundle.tar.gz`. The three pinned values are the hex strings in the `assert_eq!` calls: (1) `hash_bytes(&manifest)`, (2) `hash_bytes(&events)`, (3) `_container_hash`. To find them: `rg "assert_eq!" crates/assay-evidence/tests/determinism_test.rs -A 1` and look at the block inside `test_golden_hash`. Update these assertions only when the writer or event *format* changes.

After any intentional change to the bundle writer or event format, regenerate and update those pinned hashes so CI stays green.

## Unknown-optional-fields fixture (normative)

The spec requires that verify MUST accept events with extra unknown top-level and payload keys. A **conformance test MUST exist**; a dedicated on-disk fixture file is **OPTIONAL** (e.g. the test can build the bundle in-memory, as `test_verify_accepts_unknown_optional_fields` does). To add or refresh: include at least one event with extra optional top-level or payload fields; run `verify` on it and assert success.

## Tools that validate these fixtures

- `assay evidence verify` — integrity and schema checks
- `assay evidence lint` — lint rules over verified bundle
- `assay evidence explore` — TUI over verified bundle
- Unit/integration tests in `crates/assay-evidence`: `verify_strict_test`, `bundle_security_test`, determinism tests, lint tests
