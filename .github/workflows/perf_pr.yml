# PR: vergelijk met main-baseline via start-point + clone-thresholds.
# Alleen same-repo PRs (secrets niet beschikbaar op forks).
# Vereist: BENCHER_PROJECT, BENCHER_API_TOKEN.
#
# Thresholds (jan 2026):
# - Cloned from main baseline (--start-point-clone-thresholds)
# - NO --err: alerts are warnings only (runner variance is too high)
name: Perf (PR compare)

on:
  pull_request:
    types: [opened, reopened, edited, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  benches:
    name: Criterion compare (PR vs main)
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    # Bencher 404 (e.g. main baseline not found) should not block PR merge
    continue-on-error: true
    env:
      QUICK: "1"
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Swatinem/rust-cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
      - name: Install Linux deps
        shell: bash
        run: |
          set -euo pipefail
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends clang libsqlite3-dev || {
            sudo DEBIAN_FRONTEND=noninteractive apt-get update -y -o Acquire::Retries=10 -o Acquire::http::Timeout=60 -o Acquire::https::Timeout=60
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends clang libsqlite3-dev
          }
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          components: rustfmt
      - uses: bencherdev/bencher@886fbed6aad69e12a7852b0fc9ce49c50516c578 # @main
      # stdin/pipe mode: cargo bench output piped to bencher run (no command after --)
      - name: Criterion (store_write_heavy)
        env:
          BENCHER_PROJECT: ${{ secrets.BENCHER_PROJECT }}
          BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$BENCHER_PROJECT" ] || [ -z "$BENCHER_API_TOKEN" ]; then echo "Bencher not configured, skipping."; exit 0; fi
          cargo bench -p assay-core --bench store_write_heavy 2>&1 \
            | grep -v "Gnuplot not found" \
            | bencher run \
                --project "$BENCHER_PROJECT" \
                --token "$BENCHER_API_TOKEN" \
                --branch "$GITHUB_HEAD_REF" \
                --start-point "$GITHUB_BASE_REF" \
                --start-point-hash '${{ github.event.pull_request.base.sha }}' \
                --start-point-clone-thresholds \
                --start-point-reset \
                --testbed ubuntu-latest \
                --adapter rust_criterion \
                --ci-id store_write_heavy \
                --github-actions "$GITHUB_TOKEN"
          test -d target/criterion
          find target/criterion -name estimates.json -print -quit | grep -q .
      - name: Criterion (suite_run_worstcase)
        env:
          BENCHER_PROJECT: ${{ secrets.BENCHER_PROJECT }}
          BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$BENCHER_PROJECT" ] || [ -z "$BENCHER_API_TOKEN" ]; then echo "Bencher not configured, skipping."; exit 0; fi
          cargo bench -p assay-cli --bench suite_run_worstcase 2>&1 \
            | grep -v "Gnuplot not found" \
            | bencher run \
                --project "$BENCHER_PROJECT" \
                --token "$BENCHER_API_TOKEN" \
                --branch "$GITHUB_HEAD_REF" \
                --start-point "$GITHUB_BASE_REF" \
                --start-point-hash '${{ github.event.pull_request.base.sha }}' \
                --start-point-clone-thresholds \
                --start-point-reset \
                --testbed ubuntu-latest \
                --adapter rust_criterion \
                --ci-id suite_run_worstcase \
                --github-actions "$GITHUB_TOKEN"
          test -d target/criterion
          find target/criterion -name estimates.json -print -quit | grep -q .
