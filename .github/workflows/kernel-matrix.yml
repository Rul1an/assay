name: Kernel Matrix CI

on:
  workflow_dispatch:
  pull_request:
    branches: [ "main" ]
    paths:
      - "crates/assay-ebpf/**"
      - "crates/assay-cli/**"
      - ".github/workflows/kernel-matrix.yml"
  push:
    branches: [ "main", "feat/*" ]

jobs:
  matrix-test:
    name: Kernel Matrix (${{ matrix.kernel }})
    runs-on: [self-hosted, linux, assay-bpf-runner]
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        kernel: ["5.15", "6.6"] # Represents old LTS and modern LTS

    env:
      CARGO_BUILD_JOBS: 2

    steps:
    - name: Configure Build Env
      run: |
        # Set unique target dir per job in WORKSPACE (larger partition than runner.temp)
        echo "CARGO_TARGET_DIR=$GITHUB_WORKSPACE/assay-target-${{ matrix.kernel }}-${{ github.run_id }}" >> $GITHUB_ENV
        # Force rustc to use WORKSPACE for intermediate files (avoiding runner.temp ENOSPC)
        echo "TMPDIR=$GITHUB_WORKSPACE/rustc-tmp-${{ matrix.kernel }}-${{ github.run_id }}" >> $GITHUB_ENV

    - name: Setup Rust Path
      run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Debug Env
      run: |
        echo "CARGO_TARGET_DIR=$CARGO_TARGET_DIR"
        echo "TMPDIR=$TMPDIR"
        env | sort | grep -E 'CARGO_TARGET_DIR|RUST|TMPDIR' || true
        (test -f $HOME/.cargo/config.toml && sed -n '1,200p' $HOME/.cargo/config.toml) || true
        (test -f .cargo/config.toml && sed -n '1,200p' .cargo/config.toml) || true

    - name: Disk Preflight
      run: |
        set -euo pipefail
        echo "=== DF -H (General) ==="
        df -h
        echo "=== Workspace Free Space ==="
        df -h "$GITHUB_WORKSPACE" || true
        echo "=== Runner Temp Free Space ==="
        df -h "${{ runner.temp }}" || true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y llvm-dev libclang-dev build-essential libbpf-dev libsqlite3-dev

        # bpftool on Ubuntu Noble is a virtual package; install the kernel-matched tools package
        KREL="$(uname -r)"
        echo "Kernel release: $KREL"

        # Try the exact kernel tools package first
        if ! sudo apt-get install -y "linux-tools-$KREL"; then
          echo "linux-tools-$KREL not found. Falling back..."
          sudo apt-get install -y linux-tools-common linux-tools-generic
        fi

        # Verify bpftool presence (best-effort)
        command -v bpftool || { echo "bpftool not found after install"; exit 1; }
        bpftool version || true

    - name: Install Rust Toolchain (Nightly Component)
      run: |
        rustup toolchain install nightly --component rust-src
        # Do NOT set default nightly to avoid polluting runner state

    - uses: actions/checkout@v4
      with:
        clean: false

    - name: Post-Checkout Permission Fix
      run: |
        set +e
        # Fix workspace permissions now that checkout is done
        sudo chown -R "$(id -u):$(id -g)" "$GITHUB_WORKSPACE" || true
        # Ensure rustup/cargo dirs are user-owned
        sudo chown -R "$(id -u):$(id -g)" "$HOME/.rustup" "$HOME/.cargo" || true
        # Clean previous build artifacts (workspace relative)
        sudo rm -rf target/ target-root-build/ || true

    - name: Prune old CI build dirs (workspace)
      run: |
        set -euo pipefail
        echo "Before prune:"
        df -h "$GITHUB_WORKSPACE" || true

        KEEP_TARGET="assay-target-${{ matrix.kernel }}-${{ github.run_id }}"
        KEEP_TMP="rustc-tmp-${{ matrix.kernel }}-${{ github.run_id }}"

        # Remove any previous assay-target-* dirs EXCEPT current one
        find "$GITHUB_WORKSPACE" -maxdepth 1 -type d -name "assay-target-*" \
          ! -name "$KEEP_TARGET" \
          -print -exec sudo rm -rf {} + || true

        # Remove any previous rustc-tmp-* dirs EXCEPT current one
        find "$GITHUB_WORKSPACE" -maxdepth 1 -type d -name "rustc-tmp-*" \
          ! -name "$KEEP_TMP" \
          -print -exec sudo rm -rf {} + || true

        echo "After prune:"
        df -h "$GITHUB_WORKSPACE" || true

     - name: Setup Build Dirs
       run: |
         set -euo pipefail
         # Create unique build dirs (now that we own the workspace)
         mkdir -p "$TMPDIR" "$CARGO_TARGET_DIR"

        # TMPDIR needs 1777 to behave like /tmp
        chmod 1777 "$TMPDIR" || true

        echo "Build Dirs Ready:"
        ls -ld "$TMPDIR" "$CARGO_TARGET_DIR"

    - name: Build eBPF (Release)
      run: cargo +nightly xtask build-ebpf --release

    - name: Build CLI (Release)
      # Uses CARGO_TARGET_DIR from env (unique per job)
      # Build the main binary only (no tests) to keep target dir clean
      run: cargo build --release --package assay-cli --bin assay

    - name: Run End-to-End Deny Smoke Test (Script)
      # ZERO-COMPILE STRATEGY: Run pre-built binary via shell script
      run: |
        set -euo pipefail

        # Resolve Artifacts
        BIN="$CARGO_TARGET_DIR/release/assay"

        # Robust lookup for eBPF
        if [ -f "target/assay-ebpf.o" ]; then
             EBPF="$PWD/target/assay-ebpf.o"
        elif [ -n "$(find target -maxdepth 4 -name 'assay-ebpf.o' -print -quit 2>/dev/null)" ]; then
             EBPF="$(find target -maxdepth 4 -name 'assay-ebpf.o' -print -quit 2>/dev/null)"
        else
             echo "Error: eBPF artifact not found"
             exit 1
        fi

        echo "Binary: $BIN"
        echo "eBPF:   $EBPF"

        # Check binary exists
        if [ ! -x "$BIN" ]; then
             echo "Error: Binary not found or not executable at $BIN"
             ls -R "$CARGO_TARGET_DIR" || true
             exit 1
        fi

        # Execute Script as Root
        # We pass the pre-built binary path env var
        sudo -E env \
          TMPDIR="$TMPDIR" \
          ASSAY_BIN="$BIN" \
          ASSAY_EBPF_PATH="$EBPF" \
          bash scripts/ci/lsm_deny_smoke.sh

    - name: Cleanup per-run dirs
      if: always()
      run: |
        set +e
        echo "Cleaning up build directories..."
        rm -rf "$CARGO_TARGET_DIR" || true
        rm -rf "$TMPDIR" || true

    - name: Failure Artifacts (P1.2 Requirement)
      if: failure() || cancelled()
      run: |
        set +e
        mkdir -p artifacts || true
        sudo dmesg -T > artifacts/dmesg.log 2>&1 || true
        sudo bpftool prog show > artifacts/bpftool_prog.log 2>&1 || true
        sudo bpftool map dump name DENY_INO > artifacts/bpftool_map_deny.log 2>&1 || true
        echo "Kernel: $(uname -r)" > artifacts/kernel.txt || true
        echo "CARGO_TARGET_DIR=${CARGO_TARGET_DIR:-}" >> artifacts/kernel.txt || true
        echo "TMPDIR=${TMPDIR:-}" >> artifacts/kernel.txt || true

    - uses: actions/upload-artifact@v4
      if: failure() || cancelled()
      with:
        name: matrix-debug-${{ matrix.kernel }}
        path: artifacts/
