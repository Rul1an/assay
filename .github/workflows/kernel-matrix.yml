name: Kernel Matrix CI

on:
  workflow_dispatch:
  pull_request:
    branches: [ "main" ]
    paths:
      - "crates/assay-ebpf/**"
      - "crates/assay-cli/**"
      - "crates/assay-evidence/**"
      - "crates/assay-sim/**"
      - "crates/assay-monitor/**"
      - "scripts/**"
      - ".github/workflows/kernel-matrix.yml"
      # Note: Cargo.toml/Cargo.lock removed - check-ebpf-changes job handles skip logic
  push:
    branches: [ "main", "debug/**" ]

permissions:
  contents: read

jobs:
  lint:
    name: Lint (pre-commit)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"

      - name: Cache pre-commit
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.cache/pre-commit
          key: precommit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            precommit-${{ runner.os }}-

      - name: Set up Rust (fmt + clippy)
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          components: rustfmt, clippy

      - name: Install pre-commit (pinned)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install pre-commit==4.4.0

      - name: Install cargo-deny (for pre-commit hook)
        run: cargo install --locked cargo-deny

      - name: Run pre-commit (all files)
        shell: bash
        run: |
          set -euo pipefail
          pre-commit run --all-files --show-diff-on-failure

  build-artifacts:
    permissions:
      contents: read
    name: Build Artifacts (Ubuntu ARM)
    needs: lint
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 20
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-build
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Dependencies
        shell: bash
        run: |
          set -euo pipefail

          # Switch Ubuntu Ports mirror with robust failover
          sudo bash scripts/ci/apt_ports_failover.sh

          # Install with strict flags (update already handled)
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            llvm-dev libclang-dev build-essential libbpf-dev pkg-config

      - name: Install Rust Toolchain (nightly)
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # nightly

      - name: Install rust-src for eBPF (explicit for ARM)
        run: |
          rustup component add rust-src --toolchain nightly
          # Verify rust-src is installed
          ls -la "$(rustup run nightly rustc --print sysroot)/lib/rustlib/src/rust/library/Cargo.lock" || {
            echo "ERROR: rust-src not found after install"
            rustup show
            exit 1
          }

      - name: Swatinem/rust-cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          cache-on-failure: true

      - name: Install bpf-linker (nightly)
        run: |
          set -euo pipefail
          cargo +nightly install bpf-linker --locked
          command -v bpf-linker

      - name: Build eBPF (Release)
        run: |
          set -euo pipefail
          cargo +nightly xtask build-ebpf --release

      - name: Build CLI (Release)
        run: |
          set -euo pipefail
          cargo +nightly build --release --package assay-cli --bin assay

      - name: Prepare Artifacts
        run: |
          set -euo pipefail
          mkdir -p dist

          # Binary
          cp -v target/release/assay dist/

          # Scripts (No-Clone Strategy)
          cp -v scripts/ci/lsm_deny_smoke.sh dist/
          cp -v scripts/ci/apt_ports_failover.sh dist/

          # Robust eBPF lookup (paths vary by build strategy)
          EBPF_PATH="$(find target -maxdepth 6 -name 'assay-ebpf.o' -type f -print -quit)"
          if [ -z "${EBPF_PATH:-}" ]; then
            echo "Error: Could not locate assay-ebpf.o under target/"
            find target -maxdepth 6 -type f -name '*ebpf*.o' -print || true
            exit 1
          fi
          cp -v "$EBPF_PATH" dist/assay-ebpf.o

          ls -lh dist/

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: assay-dist
          path: dist/
          if-no-files-found: error

  # Check if eBPF-related files were changed (skip heavy tests for pure dep bumps)
  check-ebpf-changes:
    name: Check eBPF Changes
    runs-on: ubuntu-latest
    outputs:
      ebpf_changed: ${{ steps.check.outputs.ebpf_changed }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Check for eBPF-related changes
        id: check
        run: |
          # For push events, compare with previous commit
          # For PRs, compare with base branch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.sha }}"
          else
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
          fi

          echo "Comparing $BASE..$HEAD"

          # Check if eBPF-related files changed (not just Cargo.toml/Cargo.lock)
          EBPF_PATTERNS="crates/assay-ebpf|crates/assay-monitor|crates/assay-evidence|scripts/ci|\.github/workflows/kernel-matrix"

          CHANGED_FILES=$(git diff --name-only "$BASE" "$HEAD" 2>/dev/null || echo "")
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if any eBPF-related file changed
          if echo "$CHANGED_FILES" | grep -qE "$EBPF_PATTERNS"; then
            echo "ebpf_changed=true" >> "$GITHUB_OUTPUT"
            echo "✅ eBPF-related files changed - full matrix test required"
          else
            echo "ebpf_changed=false" >> "$GITHUB_OUTPUT"
            echo "⏭️ Only dependency changes - skipping heavy matrix tests"
          fi

  cleanup-runner:
    name: Free disk (before matrix)
    needs: [lint, build-artifacts, check-ebpf-changes]
    # Skip for fork PRs OR when only dependencies changed (no eBPF code)
    if: |
      (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) &&
      needs.check-ebpf-changes.outputs.ebpf_changed == 'true'
    runs-on: [self-hosted, linux, assay-bpf-runner]
    timeout-minutes: 5
    steps:
      - name: Nuke _actions cache (force fresh download for next job)
        shell: bash
        run: |
          set +e
          # Runner loads actions *before* first step of next job.
          # Files may be immutable (chattr +i) - remove that first, then delete.
          echo "Removing immutable flags and _work/_actions..."
          sudo chattr -R -i /opt/actions-runner/_work/_actions 2>/dev/null || true
          sudo rm -rf /opt/actions-runner/_work/_actions 2>/dev/null || true
          if [ -n "${RUNNER_WORKDIR:-}" ]; then
            sudo chattr -R -i "${RUNNER_WORKDIR}/_actions" 2>/dev/null || true
            sudo rm -rf "${RUNNER_WORKDIR}/_actions" 2>/dev/null || true
          fi
          # Recreate with correct ownership
          sudo mkdir -p /opt/actions-runner/_work/_actions
          sudo chown -R "$(id -u):$(id -g)" /opt/actions-runner/_work/_actions
          echo "Done. _actions directory ready for fresh downloads."
      - name: Free disk (always before matrix-test)
        shell: bash
        run: |
          set +e
          echo "=== Disk before ==="
          df -h / || true
          sudo docker system prune -af --volumes 2>/dev/null || true
          sudo apt-get clean 2>/dev/null || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* 2>/dev/null || true
          # RUNNER_DIR="/opt/actions-runner"
          # sudo rm -rf "${RUNNER_DIR}/_work/_temp" "${RUNNER_DIR}/_work/_tool" "${RUNNER_DIR}/_work/_actions" 2>/dev/null || true
          echo "=== Disk after ==="
          df -h / || true

  matrix-test:
    permissions:
      contents: read
      actions: write
    name: Kernel Matrix (${{ matrix.kernel }})
    needs: [lint, build-artifacts, cleanup-runner, check-ebpf-changes]
    if: |
      (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) &&
      needs.check-ebpf-changes.outputs.ebpf_changed == 'true'
    runs-on: [self-hosted, linux, assay-bpf-runner]
    timeout-minutes: 10
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}-${{ matrix.kernel }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        kernel: ["5.15", "6.6"]

    env:
      CARGO_INCREMENTAL: 0

    steps:
      - name: Emergency cleanup (FIX PERMS)
        shell: bash
        run: |
          set +eu
          echo "=== Disk before ==="
          df -h || true
          echo "=== Top 25 Root Directories ==="
          sudo du -xhd 1 / | sort -hr | head -n 25 || true

          # kill workspace no matter who owns it
          sudo rm -rf "$GITHUB_WORKSPACE" || true
          sudo mkdir -p "$GITHUB_WORKSPACE"
          sudo chown -R "$(id -u):$(id -g)" "$GITHUB_WORKSPACE" || true

          # Fix actions cache so checkout can load (self-hosted may have root-owned _actions)
          if [ -d "/opt/actions-runner/_work/_actions" ]; then
            sudo chown -R "$(id -u):$(id -g)" "/opt/actions-runner/_work/_actions" 2>/dev/null || true
          fi
          if [ -n "${RUNNER_WORKDIR:-}" ] && [ -d "${RUNNER_WORKDIR}/_actions" ]; then
            sudo chown -R "$(id -u):$(id -g)" "${RUNNER_WORKDIR}/_actions" 2>/dev/null || true
          fi

          # runner internals (best effort)
          if [ -n "${RUNNER_WORKDIR:-}" ]; then
            # sudo rm -rf "${RUNNER_WORKDIR}/_temp" "${RUNNER_WORKDIR}/_tool" "${RUNNER_WORKDIR}/_actions" 2>/dev/null || true
            true
          fi

          # docker + apt caches (optional)
          sudo docker system prune -af --volumes || true
          # sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* || true
          # sudo apt-get clean || true

          echo "=== Disk after ==="
          df -h || true



      - name: Disk Threshold Gate (2.5GB)
        shell: bash
        run: |
          set -euo pipefail
          AVAIL_KB="$(df -Pk "$GITHUB_WORKSPACE" | awk 'NR==2 {print $4}')"
          echo "Workspace available KB: $AVAIL_KB"
          # Require at least ~2.5GiB free in workspace
          if [ "$AVAIL_KB" -lt 2621440 ]; then
            echo "ERROR: Not enough free space (need >= ~2.5GiB)."
            exit 1
          fi

      - name: Configure Execution Env (TMPDIR in RAM)
        shell: bash
        run: |
          set -euo pipefail
          echo "TMPDIR=/dev/shm/assay-tmp-${{ matrix.kernel }}-${{ github.run_id }}" >> "$GITHUB_ENV"

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: assay-dist
          path: dist

      - name: Install Runtime Dependencies (Minimal)
        shell: bash
        run: |
          set -euo pipefail

          # If this is an ARM Ubuntu runner (ports.ubuntu.com), switch using robust failover
          # Note: script comes from 'dist' artifact
          chmod +x dist/apt_ports_failover.sh
          sudo bash dist/apt_ports_failover.sh

          # Install minimal deps (no-install-recommends is critical to avoid LLVM/Clang)
          sudo apt-get install -y --no-install-recommends \
            libbpf-dev \
            libsqlite3-dev

          KREL="$(uname -r)"
          if ! sudo apt-get install -y --no-install-recommends "linux-tools-$KREL"; then
            sudo apt-get install -y --no-install-recommends linux-tools-common linux-tools-generic || true
          fi

          # Post-clean to free space immediately
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* || true

          echo "=== Disk After Install ==="
          df -h / "$GITHUB_WORKSPACE" || true



          command -v bpftool >/dev/null 2>&1 || echo "WARN: bpftool not found (failure artifacts may be limited)"

      - name: Debug Artifacts
        shell: bash
        run: |
          ls -lh dist/

      - name: Fix Permissions
        shell: bash
        run: |
          set -euo pipefail
          sudo chown -R "$(id -u):$(id -g)" "$GITHUB_WORKSPACE" || true
          cd "$GITHUB_WORKSPACE"
          chmod +x dist/assay dist/lsm_deny_smoke.sh

      - name: Run End-to-End Deny Smoke Test
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"

          test -f dist/assay || { echo "Missing binary"; ls -R dist; exit 1; }
          test -f dist/assay-ebpf.o || { echo "Missing eBPF"; ls -R dist; exit 1; }
          test -f dist/lsm_deny_smoke.sh || { echo "Missing script"; ls -R dist; exit 1; }

          # Use RAM for tmp
          mkdir -p "$TMPDIR"
          chmod 1777 "$TMPDIR" || true

          sudo -E env \
            TMPDIR="$TMPDIR" \
            ASSAY_BIN="$PWD/dist/assay" \
            ASSAY_EBPF_PATH="$PWD/dist/assay-ebpf.o" \
            bash "$PWD/dist/lsm_deny_smoke.sh"

      - name: Cleanup per-run dirs
        if: always()
        shell: bash
        run: |
          set +e
          rm -rf "$TMPDIR" || true
          rm -rf "$GITHUB_WORKSPACE/dist" || true

      - name: Failure Artifacts
        if: failure()
        shell: bash
        run: |
          set +e
          cd "$GITHUB_WORKSPACE" || true
          mkdir -p artifacts
          sudo dmesg -T | sudo tee artifacts/dmesg.log > /dev/null 2>&1 || true
          if command -v bpftool >/dev/null 2>&1; then
            sudo bpftool prog show | sudo tee artifacts/bpftool_prog.log > /dev/null 2>&1 || true
            sudo bpftool map dump name DENY_INO | sudo tee artifacts/bpftool_map_deny.log > /dev/null 2>&1 || true
          else
            echo "bpftool not available" | sudo tee artifacts/bpftool_missing.txt > /dev/null || true
          fi
          echo "Kernel: $(uname -r)" | sudo tee artifacts/kernel.txt > /dev/null || true
          echo "Arch: $(uname -m)" | sudo tee -a artifacts/kernel.txt > /dev/null || true

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: failure()
        with:
          name: matrix-debug-${{ matrix.kernel }}
          path: artifacts/
          if-no-files-found: ignore
          retention-days: 7

      - name: Free disk for next run
        if: always()
        shell: bash
        run: |
          set +e
          echo "=== Freeing disk for next job (prevent No space left on device) ==="
          sudo docker system prune -af --volumes 2>/dev/null || true
          sudo apt-get clean 2>/dev/null || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* 2>/dev/null || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* 2>/dev/null || true
          df -h / || true

  # Summary job for PR status - always runs to report outcome
  summary:
    name: Kernel Matrix Summary
    runs-on: ubuntu-latest
    needs: [lint, build-artifacts, check-ebpf-changes, matrix-test]
    if: always()
    steps:
      - name: Report Status
        env:
          EBPF_CHANGED: ${{ needs.check-ebpf-changes.outputs.ebpf_changed }}
          MATRIX_RESULT: ${{ needs.matrix-test.result }}
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## Kernel Matrix CI Summary"
            echo ""

            if [ "${EBPF_CHANGED}" = "false" ]; then
              echo "⏭️ **Matrix tests skipped** - No eBPF-related changes detected"
              echo ""
              echo "Only Cargo.toml/Cargo.lock changed. Heavy kernel matrix tests not required."
            elif [ "${MATRIX_RESULT}" = "success" ]; then
              echo "✅ **All kernel matrix tests passed**"
            elif [ "${MATRIX_RESULT}" = "skipped" ]; then
              echo "⏭️ **Matrix tests skipped** (fork PR or no eBPF changes)"
            else
              echo "❌ **Matrix tests failed**"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          # Fail if matrix tests actually failed
          if [ "${EBPF_CHANGED}" = "true" ] && [ "${MATRIX_RESULT}" = "failure" ]; then
            exit 1
          fi

      - name: Check lint status
        if: needs.lint.result == 'failure'
        run: |
          echo "Lint failed"
          exit 1

      - name: Check build status
        if: needs.build-artifacts.result == 'failure'
        run: |
          echo "Build failed"
          exit 1
