name: Kernel Matrix CI

on:
  workflow_dispatch:
  pull_request:
    branches: [ "main" ]
    paths:
      - "crates/assay-ebpf/**"
      - "crates/assay-cli/**"
      - ".github/workflows/kernel-matrix.yml"
  push:
    branches: [ "main", "feat/*" ]

jobs:
  build-artifacts:
    name: Build Artifacts (Ubuntu ARM)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y llvm-dev libclang-dev build-essential libbpf-dev pkg-config

      - name: Install Rust Toolchain (nightly rust-src only)
        run: |
          set -euo pipefail
          rustup toolchain install nightly --profile minimal --component rust-src

      - name: Install bpf-linker
        run: |
          set -euo pipefail
          cargo install bpf-linker --locked
          command -v bpf-linker

      - name: Build eBPF (Release)
        run: |
          set -euo pipefail
          cargo +nightly xtask build-ebpf --release

      - name: Build CLI (Release)
        run: |
          set -euo pipefail
          cargo build --release --package assay-cli --bin assay

      - name: Prepare Artifacts
        run: |
          set -euo pipefail
          mkdir -p dist

          # Binary
          cp -v target/release/assay dist/

          # Robust eBPF lookup (paths vary by build strategy)
          EBPF_PATH="$(find target -maxdepth 6 -name 'assay-ebpf.o' -type f -print -quit)"
          if [ -z "${EBPF_PATH:-}" ]; then
            echo "Error: Could not locate assay-ebpf.o under target/"
            find target -maxdepth 6 -type f -name '*ebpf*.o' -print || true
            exit 1
          fi
          cp -v "$EBPF_PATH" dist/assay-ebpf.o

          ls -lh dist/

      - uses: actions/upload-artifact@v4
        with:
          name: assay-dist
          path: dist/
          if-no-files-found: error

  matrix-test:
    name: Kernel Matrix (${{ matrix.kernel }})
    needs: build-artifacts
    runs-on: [self-hosted, linux, assay-bpf-runner]
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        kernel: ["5.15", "6.6"]

    env:
      CARGO_INCREMENTAL: 0

    steps:
      - name: Emergency cleanup (Manual, no actions/*)
        shell: bash
        run: |
          set +e
          echo "=== Disk before ==="
          df -h || true

          # Big wins on self-hosted runners:
          # If RUNNER_WORKDIR is empty/unset, these will fail safely or do nothing
          # Note: We use sudo rm -rf to ensure we really kill everything.
          [ -n "$RUNNER_WORKDIR" ] && sudo rm -rf "$RUNNER_WORKDIR/_actions" 2>/dev/null || true
          [ -n "$RUNNER_WORKDIR" ] && sudo rm -rf "$RUNNER_WORKDIR/_tool" 2>/dev/null || true
          [ -n "$RUNNER_WORKDIR" ] && sudo rm -rf "$RUNNER_WORKDIR/_temp" 2>/dev/null || true

          # Workspace cruft
          rm -rf "$GITHUB_WORKSPACE"/* || true

          # Cargo caches (optional)
          rm -rf "$HOME/.cargo/registry/cache" || true
          rm -rf "$HOME/.cargo/git/checkouts" || true

          # Docker (if you use it)
          sudo docker system prune -af --volumes || true

          echo "=== Disk after ==="
          df -h || true

      - name: Manual checkout (no actions/checkout)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          rm -rf repo
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" repo
          cd repo
          git fetch origin "${GITHUB_SHA}"
          git checkout --detach "${GITHUB_SHA}"

      - name: Disk Threshold Gate (3.5GB)
        run: |
          set -euo pipefail
          AVAIL_KB="$(df -Pk "$GITHUB_WORKSPACE" | awk 'NR==2 {print $4}')"
          echo "Workspace available KB: $AVAIL_KB"
          if [ "$AVAIL_KB" -lt 3670016 ]; then
            echo "ERROR: Not enough free space (need >= ~3.5GiB)."
            exit 1
          fi

      - name: Configure Execution Env
        run: |
          set -euo pipefail
          echo "TMPDIR=$GITHUB_WORKSPACE/rustc-tmp-${{ matrix.kernel }}-${{ github.run_id }}" >> $GITHUB_ENV

      - name: Install Runtime Dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libbpf-dev libsqlite3-dev

          KREL="$(uname -r)"
          if ! sudo apt-get install -y "linux-tools-$KREL"; then
            sudo apt-get install -y linux-tools-common linux-tools-generic || true
          fi
          command -v bpftool >/dev/null 2>&1 || echo "WARN: bpftool not found (failure artifacts may be limited)"

      - name: Download assay-dist artifact via API (Manual)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          cd repo

          # List artifacts for this workflow run
          API="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/artifacts"
          ART_ID="$(curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$API" | python3 - <<'PY'
          import json,sys
          data=json.load(sys.stdin)
          for a in data.get("artifacts",[]):
            if a.get("name")=="assay-dist":
              print(a["id"]); break
          else:
            raise SystemExit("assay-dist artifact not found")
          PY
          )"

          echo "Artifact id: $ART_ID"

          # Download zip
          ZIP_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/artifacts/${ART_ID}/zip"
          rm -rf dist && mkdir -p dist
          curl -fL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$ZIP_URL" -o dist/assay-dist.zip

          unzip -o dist/assay-dist.zip -d dist
          ls -lh dist

      - name: Fix Permissions
        run: |
          set -euo pipefail
          sudo chown -R "$(id -u):$(id -g)" "$GITHUB_WORKSPACE" || true
          cd repo
          chmod +x dist/assay

      - name: Run End-to-End Deny Smoke Test
        run: |
          set -euo pipefail

          cd repo
          test -f dist/assay || { echo "Missing binary"; ls -R dist; exit 1; }
          test -f dist/assay-ebpf.o || { echo "Missing eBPF"; ls -R dist; exit 1; }

          mkdir -p "$TMPDIR"
          chmod 1777 "$TMPDIR" || true

          sudo -E env \
            TMPDIR="$TMPDIR" \
            # Note: repo/ is the checkout dir now
            ASSAY_BIN="$PWD/repo/dist/assay" \
            ASSAY_EBPF_PATH="$PWD/repo/dist/assay-ebpf.o" \
            bash scripts/ci/lsm_deny_smoke.sh

      - name: Cleanup per-run dirs
        if: always()
        run: |
          set +e
          rm -rf "$TMPDIR" || true
          rm -rf repo/dist/ || true

      - name: Failure Artifacts
        if: failure()
        run: |
          set +e
          mkdir -p artifacts
          sudo dmesg -T > artifacts/dmesg.log 2>&1 || true
          if command -v bpftool >/dev/null 2>&1; then
            sudo bpftool prog show > artifacts/bpftool_prog.log 2>&1 || true
            sudo bpftool map dump name DENY_INO > artifacts/bpftool_map_deny.log 2>&1 || true
          else
            echo "bpftool not available" > artifacts/bpftool_missing.txt
          fi
          echo "Kernel: $(uname -r)" > artifacts/kernel.txt || true
          echo "Arch: $(uname -m)" >> artifacts/kernel.txt || true

      # - uses: actions/upload-artifact@v4
      #   if: failure()
      #   with:
      #     name: matrix-debug-${{ matrix.kernel }}
      #     path: artifacts/
