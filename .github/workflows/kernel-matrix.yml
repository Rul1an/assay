name: Kernel Matrix CI

on:
  workflow_dispatch:
  pull_request:
    branches: [ "main" ]
    paths:
      - "crates/assay-ebpf/**"
      - "crates/assay-cli/**"
      - ".github/workflows/kernel-matrix.yml"
  push:
    branches: [ "main", "feat/*" ]

jobs:
  build-artifacts:
    name: Build Artifacts (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-dev libclang-dev build-essential libbpf-dev \
            gcc-aarch64-linux-gnu libc6-dev-arm64-cross

      - name: Install Rust Toolchain
        run: |
          rustup toolchain install nightly --component rust-src
          rustup default nightly
          rustup target add aarch64-unknown-linux-gnu

      - name: Build eBPF
        run: cargo xtask build-ebpf --release

      - name: Build CLI (ARM64)
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: cargo build --release --package assay-cli --bin assay --target aarch64-unknown-linux-gnu

      - name: Prepare Artifacts
        run: |
          mkdir -p dist
          cp target/aarch64-unknown-linux-gnu/release/assay dist/
          cp target/assay-ebpf.o dist/
          ls -lh dist/

      - uses: actions/upload-artifact@v4
        with:
          name: assay-dist
          path: dist/
          if-no-files-found: error

  matrix-test:
    name: Kernel Matrix (${{ matrix.kernel }})
    needs: build-artifacts
    runs-on: [self-hosted, linux, assay-bpf-runner]
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        kernel: ["5.15", "6.6"] # Represents old LTS and modern LTS

    env:
      CARGO_INCREMENTAL: 0

    steps:
    - name: Emergency Runner Cleanup (Pre-Flight)
      run: |
        set +e
        echo "=== Pruning workspace (emergency start) ==="
        # Nuke current workspace content to ensure clean slate
        rm -rf "$GITHUB_WORKSPACE"/* || true

        echo "=== Pruning Cargo caches (hygiene) ==="
        du -sh "$HOME/.cargo/registry" "$HOME/.cargo/git" 2>/dev/null || true
        find "$HOME/.cargo/registry/cache" -type f -mtime +14 -delete 2>/dev/null || true
        find "$HOME/.cargo/registry/index" -type f -mtime +30 -delete 2>/dev/null || true
        find "$HOME/.cargo/git/checkouts" -maxdepth 2 -mindepth 2 -type d -mtime +30 -exec rm -rf {} + 2>/dev/null || true
        find "$HOME/.cargo/git/db" -maxdepth 1 -mindepth 1 -type d -mtime +30 -exec rm -rf {} + 2>/dev/null || true

        echo "=== Docker Prune ==="
        sudo docker system prune -af --volumes || true

        echo "=== Disk Usage After Prune ==="
        df -h "$GITHUB_WORKSPACE" || true

    - name: Disk Threshold Gate (3.5GB)
      run: |
        set -euo pipefail
        # Require at least ~3.5GiB free in workspace
        AVAIL_KB="$(df -Pk "$GITHUB_WORKSPACE" | awk 'NR==2 {print $4}')"
        echo "Workspace available KB: $AVAIL_KB"
        if [ "$AVAIL_KB" -lt 3670016 ]; then
          echo "ERROR: Not enough free space (need >= ~3.5GiB)."
          exit 1
        fi

    - name: Configure Execution Env
      run: |
        echo "TMPDIR=$GITHUB_WORKSPACE/rustc-tmp-${{ matrix.kernel }}-${{ github.run_id }}" >> $GITHUB_ENV

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libbpf-dev libsqlite3-dev

        KREL="$(uname -r)"
        if ! sudo apt-get install -y "linux-tools-$KREL"; then
           sudo apt-get install -y linux-tools-common linux-tools-generic || true
        fi

    - uses: actions/download-artifact@v4
      with:
        name: assay-dist
        path: dist

    - uses: actions/checkout@v4
      with:
        clean: false # Managed by emergency cleanup

    - name: Fix Permissions (Checkout)
      run: |
        sudo chown -R "$(id -u):$(id -g)" "$GITHUB_WORKSPACE" || true
        chmod +x dist/assay

    - name: Run End-to-End Deny Smoke Test
      run: |
        set -euo pipefail

        # Verify Artifacts
        test -f dist/assay || { echo "Missing binary"; ls -R dist; exit 1; }
        test -f dist/assay-ebpf.o || { echo "Missing eBPF"; ls -R dist; exit 1; }

        # Setup Isolation
        mkdir -p "$TMPDIR"
        chmod 1777 "$TMPDIR"

        # Execute
        sudo -E env \
          TMPDIR="$TMPDIR" \
          ASSAY_BIN="$PWD/dist/assay" \
          ASSAY_EBPF_PATH="$PWD/dist/assay-ebpf.o" \
          bash scripts/ci/lsm_deny_smoke.sh

    - name: Cleanup per-run dirs
      if: always()
      run: |
         rm -rf "$TMPDIR" || true
         rm -rf dist/ || true

    - name: Failure Artifacts
      if: failure()
      run: |
        mkdir -p artifacts
        sudo dmesg -T > artifacts/dmesg.log 2>&1 || true
        sudo bpftool prog show > artifacts/bpftool_prog.log 2>&1 || true
        sudo bpftool map dump name DENY_INO > artifacts/bpftool_map_deny.log 2>&1 || true

    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: matrix-debug-${{ matrix.kernel }}
        path: artifacts/
