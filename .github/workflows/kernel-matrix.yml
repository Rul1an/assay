name: Kernel Matrix CI

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - "crates/assay-ebpf/**"
      - "crates/assay-cli/**"
      - ".github/workflows/kernel-matrix.yml"
  push:
    branches: [ "main" ]

jobs:
  matrix-test:
    name: Kernel Matrix (${{ matrix.kernel }})
    runs-on: [self-hosted, linux, assay-bpf-runner]
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        kernel: ["5.15", "6.6"] # Represents old LTS and modern LTS

    steps:
    - uses: actions/checkout@v4

    - name: Cleanup Workspace
      run: |
        cargo clean || true
        sudo rm -rf target/
        # Clean shared temp artifacts from other workflows preventing disk exhaustion
        sudo rm -rf /tmp/assay-lsm-verify /tmp/assay-test

    - name: Build eBPF (Release)
      run: cargo xtask build-ebpf --release

    - name: Build CLI (Release)
      run: cargo build --release --package assay-cli

    - name: Run End-to-End Deny Smoke Test
      # This assumes the self-hosted runner has sudo NOPASSWD or runs as root-capable user.
      # The runners are expected to be booted into the target kernel via VM infra externally
      # OR this job selects a runner with that kernel.
      #
      # Since we only have one 'assay-bpf-runner' currently active (likely one kernel),
      # effectively this matrix will run twice on the SAME runner unless the runner
      # dynamically provides kernels.
      #
      # Per P1.2 requirement: "Source of Truth: Kernels booted in VM infra; jobs run on assay-bpf-runner".
      # We assume the runner environment manages the kernel or checking `uname -r` is sufficient
      # to log context.
      run: |
        echo "Running on Kernel: $(uname -r)"
        # P1.3 End-to-End Deny Smoke Test (Requires Root)
        # We need to ensure 'assay' bin is available if the test spawns it using Command::cargo_bin.
        # However, `cargo test` doesn't automatically install binaries for `cargo_bin` to find
        # unless `cargo build` ran first (which it did).

        sudo -E cargo test --release --package assay-cli --test lsm_deny_smoke -- --nocapture
      continue-on-error: true

    - name: Failure Artifacts (P1.2 Requirement)
      if: failure() || cancelled()
      run: |
        mkdir -p artifacts
        dmesg > artifacts/dmesg.log
        sudo bpftool prog show > artifacts/bpftool_prog.log
        sudo bpftool map dump name DENY_INO > artifacts/bpftool_map_deny.log
        # Copy any local assay logs if they exist (assuming stdout captured above or file logging)

    - uses: actions/upload-artifact@v4
      if: failure() || cancelled()
      with:
        name: matrix-debug-${{ matrix.kernel }}
        path: artifacts/
