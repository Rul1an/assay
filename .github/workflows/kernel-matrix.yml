name: Kernel Matrix CI

on:
  workflow_dispatch:
  pull_request:
    branches: [ "main" ]
    paths:
      - "crates/assay-ebpf/**"
      - "crates/assay-cli/**"
      - ".github/workflows/kernel-matrix.yml"
  push:
    branches: [ "main", "feat/*" ]

jobs:
  matrix-test:
    name: Kernel Matrix (${{ matrix.kernel }})
    runs-on: [self-hosted, linux, assay-bpf-runner]
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        kernel: ["5.15", "6.6"] # Represents old LTS and modern LTS

    env:
      CARGO_BUILD_JOBS: 2

    steps:
    - name: Configure Build Env
      run: |
        # Set unique target dir per job using runner.temp (only available in steps)
        echo "CARGO_TARGET_DIR=${{ runner.temp }}/assay-target-${{ matrix.kernel }}-${{ github.run_id }}" >> $GITHUB_ENV
        # Force rustc to use runner.temp for intermediate files (avoiding /tmp EPERM)
        echo "TMPDIR=${{ runner.temp }}/rustc-tmp-${{ matrix.kernel }}-${{ github.run_id }}" >> $GITHUB_ENV

    - name: Setup Rust Path
      run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Debug Env
      run: |
        echo "CARGO_TARGET_DIR=$CARGO_TARGET_DIR"
        echo "TMPDIR=$TMPDIR"
        env | sort | grep -E 'CARGO_TARGET_DIR|RUST|TMPDIR' || true
        (test -f $HOME/.cargo/config.toml && sed -n '1,200p' $HOME/.cargo/config.toml) || true
        (test -f .cargo/config.toml && sed -n '1,200p' .cargo/config.toml) || true

    - name: Setup TMPDIR (avoid /tmp EPERM)
      run: |
        set -euo pipefail
        mkdir -p "$TMPDIR"
        chmod 1777 "$TMPDIR" || true
        echo "TMPDIR is $TMPDIR"
        # quick smoke write test
        touch "$TMPDIR/assay-tmp-test" && rm -f "$TMPDIR/assay-tmp-test"

    - name: Diagnose /tmp (optional)
      run: |
        ls -ld /tmp || true
        stat -c "%A %a %U:%G %n" /tmp || true
        mount | grep ' on /tmp ' || true
        touch /tmp/assay-ci-write-test && rm -f /tmp/assay-ci-write-test || true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y llvm-dev libclang-dev build-essential libbpf-dev libsqlite3-dev

        # bpftool on Ubuntu Noble is a virtual package; install the kernel-matched tools package
        KREL="$(uname -r)"
        echo "Kernel release: $KREL"

        # Try the exact kernel tools package first
        if ! sudo apt-get install -y "linux-tools-$KREL"; then
          echo "linux-tools-$KREL not found. Falling back to linux-tools-generic..."
          sudo apt-get install -y linux-tools-generic linux-tools-common || true
        fi

        # Verify bpftool presence (best-effort)
        command -v bpftool || { echo "bpftool not found after install"; exit 1; }
        bpftool version || true

    - name: Install Rust Toolchain (Nightly Component)
      run: |
        rustup toolchain install nightly --component rust-src
        # Do NOT set default nightly to avoid polluting runner state

    - uses: actions/checkout@v4
      with:
        clean: false

    - name: Post-Checkout Permission Fix
      run: |
         # Fix workspace permissions now that checkout is done
         sudo chown -R "$(id -u):$(id -g)" "$GITHUB_WORKSPACE" || true

         # Clean previous build artifacts (workspace relative)
         sudo rm -rf target/ target-root-build/

         # Ensure rustup/cargo dirs are user-owned
         sudo chown -R "$(id -u):$(id -g)" "$HOME/.rustup" "$HOME/.cargo" || true

    - name: Build eBPF (Release)
      run: cargo +nightly xtask build-ebpf --release

    - name: Build CLI (Release)
      # Uses CARGO_TARGET_DIR from env (unique per job)
      run: cargo build --release --package assay-cli

    - name: Run End-to-End Deny Smoke Test
      # ISOLATION: Use a separate target dir for SUDO to prevent locking the main build dir
      run: |
        set -euo pipefail
        echo "Running on Kernel: $(uname -r)"
        export CARGO_TARGET_DIR="${{ runner.temp }}/assay-target-root-${{ matrix.kernel }}-${{ github.run_id }}"
        mkdir -p "$CARGO_TARGET_DIR"

        # Robustly find the eBPF artifact (paths vary by build method)
        ASSAY_EBPF_PATH=""
        if [ -f "target/assay-ebpf.o" ]; then
            ASSAY_EBPF_PATH="$PWD/target/assay-ebpf.o"
        elif [ -n "$(find target -maxdepth 4 -name 'assay-ebpf.o' -print -quit 2>/dev/null)" ]; then
            ASSAY_EBPF_PATH="$(find target -maxdepth 4 -name 'assay-ebpf.o' -print -quit 2>/dev/null)"
        else
            echo "Error: Could not locate assay-ebpf.o"
            exit 1
        fi
        echo "Using ASSAY_EBPF_PATH=$ASSAY_EBPF_PATH"
        export ASSAY_EBPF_PATH

        # Run test as root, forcing it to use the ROOT specific target dir
        # Note: continue-on-error removed for strict gating
        sudo -E env TMPDIR="$TMPDIR" CARGO_TARGET_DIR="$CARGO_TARGET_DIR" "$HOME/.cargo/bin/cargo" test --release --package assay-cli --test lsm_deny_smoke -- --nocapture
      # continue-on-error: true # Removed for strict gating

    - name: Failure Artifacts (P1.2 Requirement)
      if: failure() || cancelled()
      run: |
        set +e
        mkdir -p artifacts || true
        sudo dmesg -T > artifacts/dmesg.log 2>&1 || true
        sudo bpftool prog show > artifacts/bpftool_prog.log 2>&1 || true
        sudo bpftool map dump name DENY_INO > artifacts/bpftool_map_deny.log 2>&1 || true
        echo "Kernel: $(uname -r)" > artifacts/kernel.txt || true
        echo "CARGO_TARGET_DIR=${CARGO_TARGET_DIR:-}" >> artifacts/kernel.txt || true
        echo "TMPDIR=${TMPDIR:-}" >> artifacts/kernel.txt || true

    - uses: actions/upload-artifact@v4
      if: failure() || cancelled()
      with:
        name: matrix-debug-${{ matrix.kernel }}
        path: artifacts/
