name: Kernel Matrix CI

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - "crates/assay-ebpf/**"
      - "crates/assay-cli/**"
      - ".github/workflows/kernel-matrix.yml"
  push:
    branches: [ "main" ]

jobs:
  matrix-test:
    name: Kernel Matrix (${{ matrix.kernel }})
    runs-on: [self-hosted, linux, assay-bpf-runner]
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        kernel: ["5.15", "6.6"] # Represents old LTS and modern LTS

    steps:
    - name: Setup Rust Path
      run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Configure Local Temp Dir
      run: |
        mkdir -p .tmp
        echo "TMPDIR=$PWD/.tmp" >> $GITHUB_ENV

    - name: Pre-Checkout Cleanup
      run: |
        # Fix permissions from previous potential root runs before checkout tries to touch anything
        # CRITITCAL: Fix ~/.rustup permissions which may be root-owned
        sudo chown -R "$(id -u):$(id -g)" "$HOME/.rustup" "$HOME/.cargo" || true

        # Clean workspace permissions
        sudo chown -R "$(id -u):$(id -g)" . || true

        # Clean build artifacts to prevent disk exhaustion and stale builds
        # cargo clean might fail if we don't have Cargo.toml yet (pre-checkout), so just rely on rm
        sudo rm -rf target/ target-root-build/
        # Make sure our local temp dir exists and is clean
        rm -rf .tmp && mkdir -p .tmp
        # Clean shared temp artifacts
        # Nuke immutable flags if they exist (common cause of EPERM in CI)
        sudo chattr -i -R /tmp/assay-lsm-verify || true
        sudo rm -rf /tmp/assay-lsm-verify /tmp/assay-test

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y llvm-dev libclang-dev build-essential libbpf-dev libsqlite3-dev

    - name: Install Rust Toolchain (Recovery)
      # In case rustup state was corrupted by previous runs
      run: |
        rustup toolchain install nightly --component rust-src
        rustup default nightly

    - uses: actions/checkout@v4
      with:
        clean: false

    - name: Build eBPF (Release)
      run: cargo xtask build-ebpf --release

    - name: Build CLI (Release)
      # Explicitly unset CARGO_TARGET_DIR to ensure we use the workspace target dir (owned by user)
      # and not any potentially leaked root-owned dir.
      run: unset CARGO_TARGET_DIR && cargo build --release --package assay-cli

    - name: Run End-to-End Deny Smoke Test
      # Use isolated target dir for root actions to not pollute workspace standard target dir
      run: |
        echo "Running on Kernel: $(uname -r)"
        # Use a subdirectory in workspace to keep cleanup easy, but separate from userspace target
        export CARGO_TARGET_DIR="$PWD/target-root-build"
        mkdir -p $CARGO_TARGET_DIR

        # Run cargo via absolute path because sudo secure_path often excludes ~/.cargo/bin
        # Export eBPF path via env var so the test can pick it up without confusing libtest harness
        export ASSAY_EBPF_PATH="$PWD/target/assay-ebpf.o"
        sudo -E "$HOME/.cargo/bin/cargo" test --release --package assay-cli --test lsm_deny_smoke -- --nocapture
      continue-on-error: true

    - name: Failure Artifacts (P1.2 Requirement)
      if: failure() || cancelled()
      run: |
        mkdir -p artifacts
        sudo dmesg > artifacts/dmesg.log
        sudo bpftool prog show > artifacts/bpftool_prog.log
        sudo bpftool map dump name DENY_INO > artifacts/bpftool_map_deny.log
        # Copy any local assay logs if they exist (assuming stdout captured above or file logging)

    - uses: actions/upload-artifact@v4
      if: failure() || cancelled()
      with:
        name: matrix-debug-${{ matrix.kernel }}
        path: artifacts/
