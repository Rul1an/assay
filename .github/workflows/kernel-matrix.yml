name: Kernel Matrix CI

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - "crates/assay-ebpf/**"
      - "crates/assay-cli/**"
      - ".github/workflows/kernel-matrix.yml"
  push:
    branches: [ "main" ]

jobs:
  matrix-test:
    name: Kernel Matrix (${{ matrix.kernel }})
    runs-on: [self-hosted, linux, assay-bpf-runner]
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        kernel: ["5.15", "6.6"] # Represents old LTS and modern LTS

    steps:
    - uses: actions/checkout@v4
      with:
        clean: false

    - name: Fix Runner Permissions & Cleanup
      run: |
        # Fix permissions from previous potential root runs
        sudo chown -R "$(id -u):$(id -g)" . || true
        # Clean build artifacts to prevent disk exhaustion and stale builds
        cargo clean || true
        rm -rf target/
        # Clean shared temp artifacts
        sudo rm -rf /tmp/assay-lsm-verify /tmp/assay-test /tmp/assay-target

    - name: Build eBPF (Release)
      run: cargo xtask build-ebpf --release

    - name: Build CLI (Release)
      run: cargo build --release --package assay-cli

    - name: Run End-to-End Deny Smoke Test
      # Use isolated target dir for root actions to not pollute workspace
      run: |
        echo "Running on Kernel: $(uname -r)"
        export CARGO_TARGET_DIR=/tmp/assay-target
        mkdir -p $CARGO_TARGET_DIR

        sudo -E cargo test --release --package assay-cli --test lsm_deny_smoke -- --nocapture
      continue-on-error: true

    - name: Failure Artifacts (P1.2 Requirement)
      if: failure() || cancelled()
      run: |
        mkdir -p artifacts
        sudo dmesg > artifacts/dmesg.log
        sudo bpftool prog show > artifacts/bpftool_prog.log
        sudo bpftool map dump name DENY_INO > artifacts/bpftool_map_deny.log
        # Copy any local assay logs if they exist (assuming stdout captured above or file logging)

    - uses: actions/upload-artifact@v4
      if: failure() || cancelled()
      with:
        name: matrix-debug-${{ matrix.kernel }}
        path: artifacts/
