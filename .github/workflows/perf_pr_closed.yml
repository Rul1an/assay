# Archive closed PR branch in Bencher so the branch no longer accumulates data.
# See https://bencher.dev/docs/how-to/github-actions/ (Pull Requests -> clean up).
name: Perf (PR archive)

on:
  pull_request:
    types: [closed]

jobs:
  archive_pr_branch:
    name: Archive closed PR branch with Bencher
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: bencherdev/bencher@886fbed6aad69e12a7852b0fc9ce49c50516c578 # @main
      - name: Archive closed PR branch with Bencher
        env:
          BENCHER_PROJECT: ${{ secrets.BENCHER_PROJECT }}
          BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
        run: |
          if [ -z "$BENCHER_PROJECT" ] || [ -z "$BENCHER_API_TOKEN" ]; then
            echo "Bencher not configured, skipping."
            exit 0
          fi
          # Archive may fail if PR was closed before any benchmarks ran (branch doesn't exist in Bencher)
          # This is expected and non-fatal
          if ! bencher archive \
            --project "$BENCHER_PROJECT" \
            --token "$BENCHER_API_TOKEN" \
            --branch "$GITHUB_HEAD_REF" 2>&1; then
            echo "::notice::Branch '$GITHUB_HEAD_REF' not found in Bencher (no benchmarks ran). Skipping archive."
          fi
