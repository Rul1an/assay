name: Action v2 Test

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'assay-action/**'
      - '.github/workflows/action-v2-test.yml'

permissions:
  contents: read
  security-events: write

jobs:
  test-no-bundles:
    name: Test (no bundles - soft exit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build Assay CLI
        run: cargo build --release -p assay-cli

      - name: Add CLI to PATH
        run: echo "${{ github.workspace }}/target/release" >> "$GITHUB_PATH"

      - name: Test action with no bundles
        uses: ./assay-action

  test-with-bundle:
    name: Test (with valid bundle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build Assay CLI
        run: cargo build --release -p assay-cli

      - name: Setup evidence directory with fixture
        run: |
          mkdir -p .assay/evidence
          cp tests/fixtures/evidence/test-bundle.tar.gz .assay/evidence/

      - name: Add CLI to PATH
        run: echo "${{ github.workspace }}/target/release" >> "$GITHUB_PATH"

      - name: Test action with bundle
        id: assay
        uses: ./assay-action
        with:
          bundles: '.assay/evidence/*.tar.gz'
          fail_on: none

      - name: Check outputs
        run: |
          echo "Verified: ${{ steps.assay.outputs.verified }}"
          echo "Errors: ${{ steps.assay.outputs.findings_error }}"
          echo "Warnings: ${{ steps.assay.outputs.findings_warn }}"

          # Verify outputs are set correctly
          if [ "${{ steps.assay.outputs.verified }}" != "true" ]; then
            echo "ERROR: Expected verified=true"
            exit 1
          fi

      - name: Verify reports created
        run: |
          echo "Reports dir: ${{ steps.assay.outputs.reports_dir }}"
          echo "Checking .assay-reports/ directory..."
          ls -la .assay-reports/ || echo "Directory not found"

          # Check SARIF file exists
          if [ -f ".assay-reports/lint.sarif" ]; then
            echo "SARIF file created"
            head -20 .assay-reports/lint.sarif
          else
            echo "Note: SARIF file not created (lint may not have output)"
          fi

      # Artifact upload is handled by the action itself (tar + upload)
