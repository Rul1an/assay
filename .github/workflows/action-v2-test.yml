name: Action v2 Test

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'assay-action/**'
      - '.github/workflows/action-v2-test.yml'

permissions:
  contents: read
  security-events: write

jobs:
  test-no-bundles:
    name: Test (no bundles - soft exit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build Assay CLI
        run: cargo build --release -p assay-cli

      - name: Add CLI to PATH
        run: echo "${{ github.workspace }}/target/release" >> "$GITHUB_PATH"

      - name: Test action with no bundles
        uses: ./assay-action

  test-with-bundle:
    name: Test (with valid bundle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build Assay CLI
        run: cargo build --release -p assay-cli

      - name: Setup evidence directory with fixture
        run: |
          mkdir -p .assay/evidence
          cp tests/fixtures/evidence/test-bundle.tar.gz .assay/evidence/

      - name: Add CLI to PATH
        run: echo "${{ github.workspace }}/target/release" >> "$GITHUB_PATH"

      - name: Test action with bundle
        id: assay
        uses: ./assay-action
        with:
          bundles: '.assay/evidence/*.tar.gz'
          fail_on: none

      - name: Check outputs
        run: |
          echo "Verified: ${{ steps.assay.outputs.verified }}"
          echo "Errors: ${{ steps.assay.outputs.findings_error }}"
          echo "Warnings: ${{ steps.assay.outputs.findings_warn }}"

          # Verify outputs are set correctly
          if [ "${{ steps.assay.outputs.verified }}" != "true" ]; then
            echo "ERROR: Expected verified=true"
            exit 1
          fi

      - name: Verify reports created
        run: |
          echo "Reports dir: ${{ steps.assay.outputs.reports_dir }}"
          echo "Checking .assay-reports/ directory..."
          ls -la .assay-reports/ || echo "Directory not found"

          # Check SARIF file exists
          if [ -f ".assay-reports/lint.sarif" ]; then
            echo "SARIF file created"
            head -20 .assay-reports/lint.sarif
          else
            echo "Note: SARIF file not created (lint may not have output)"
          fi

      # Artifact upload is handled by the action itself (tar + upload)

  test-with-pack:
    name: Test (with compliance pack)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build Assay CLI
        run: cargo build --release -p assay-cli

      - name: Setup evidence directory with fixture
        run: |
          mkdir -p .assay/evidence
          cp tests/fixtures/evidence/test-bundle.tar.gz .assay/evidence/

      - name: Add CLI to PATH
        run: echo "${{ github.workspace }}/target/release" >> "$GITHUB_PATH"

      - name: Test action with compliance pack
        id: assay_pack
        uses: ./assay-action
        with:
          bundles: '.assay/evidence/*.tar.gz'
          fail_on: none
          pack: eu-ai-act-baseline

      - name: Validate pack outputs
        run: |
          echo "Pack status: ${{ steps.assay_pack.outputs.pack_status }}"
          echo "Resolved packs: ${{ steps.assay_pack.outputs.resolved_pack_refs }}"
          echo "Pack score: ${{ steps.assay_pack.outputs.pack_score }}"

          if [ "${{ steps.assay_pack.outputs.pack_status }}" != "success" ]; then
            echo "ERROR: expected pack_status=success"
            exit 1
          fi

          if [ -z "${{ steps.assay_pack.outputs.resolved_pack_refs }}" ]; then
            echo "ERROR: expected resolved_pack_refs to be set"
            exit 1
          fi

  test-missing-pack-fails-cleanly:
    name: Test (missing compliance pack failure mode)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build Assay CLI
        run: cargo build --release -p assay-cli

      - name: Setup evidence directory with fixture
        run: |
          mkdir -p .assay/evidence
          cp tests/fixtures/evidence/test-bundle.tar.gz .assay/evidence/

      - name: Add CLI to PATH
        run: echo "${{ github.workspace }}/target/release" >> "$GITHUB_PATH"

      - name: Run action with missing pack (expected failure)
        id: assay_missing_pack
        continue-on-error: true
        uses: ./assay-action
        with:
          bundles: '.assay/evidence/*.tar.gz'
          fail_on: none
          pack: definitely-not-a-real-pack

      - name: Validate failure mode outputs
        run: |
          echo "Step outcome: ${{ steps.assay_missing_pack.outcome }}"
          echo "Pack status: ${{ steps.assay_missing_pack.outputs.pack_status }}"
          echo "Pack error kind: ${{ steps.assay_missing_pack.outputs.pack_error_kind }}"

          if [ "${{ steps.assay_missing_pack.outcome }}" != "failure" ]; then
            echo "ERROR: expected action step to fail on missing pack"
            exit 1
          fi

          if [ "${{ steps.assay_missing_pack.outputs.pack_status }}" != "missing_pack" ]; then
            echo "ERROR: expected pack_status=missing_pack"
            exit 1
          fi

          if [ "${{ steps.assay_missing_pack.outputs.pack_error_kind }}" != "missing_pack" ]; then
            echo "ERROR: expected pack_error_kind=missing_pack"
            exit 1
          fi
