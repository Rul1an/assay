name: Docs Link Check

on:
  pull_request:
    paths:
      - "docs/**"
      - "mkdocs.yml"
      - ".github/workflows/docs-link-check.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  local-links:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Collect changed docs files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.sha }}"
            files=$(git diff --name-only "$base" "$head" -- 'docs/**/*.md' || true)
          else
            files=$(git diff --name-only HEAD~1 HEAD -- 'docs/**/*.md' || true)
          fi

          if [ -z "$files" ]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            printf '%s\n' "$files" > changed_docs.txt
          fi

      - name: Check local markdown links
        if: steps.changed.outputs.has_files == 'true'
        run: |
          python3 - <<'PY'
          import pathlib
          import re
          import sys

          repo = pathlib.Path(".").resolve()
          link_re = re.compile(r"\[[^\]]*\]\(([^)]+)\)")
          changed_files = [
              line.strip()
              for line in pathlib.Path("changed_docs.txt").read_text(encoding="utf-8").splitlines()
              if line.strip()
          ]

          failures = []
          for rel in changed_files:
              md = (repo / rel).resolve()
              if not md.exists():
                  continue
              text = md.read_text(encoding="utf-8")
              for lineno, line in enumerate(text.splitlines(), start=1):
                  for match in link_re.finditer(line):
                      raw = match.group(1).strip().strip("<>").strip()
                      if not raw:
                          continue

                      # Skip external and intra-page references.
                      if raw.startswith(("http://", "https://", "mailto:", "#")):
                          continue
                      if raw.startswith(("javascript:", "data:")):
                          continue
                      if raw.startswith(("{{", "{%")):
                          continue

                      target = raw.split("#", 1)[0].strip()
                      if not target:
                          continue
                      if target in {"url", "link", "..."}:
                          continue

                      if target.startswith("/"):
                          candidate = repo / target.lstrip("/")
                      else:
                          candidate = (md.parent / target).resolve()

                      if candidate.exists():
                          continue

                      failures.append(f"{md.relative_to(repo)}:{lineno} -> {raw}")

          if failures:
              print("Broken local markdown links detected:")
              for item in failures:
                  print(f"  - {item}")
              sys.exit(1)

          print("OK: all local markdown links resolve.")
          PY

      - name: No docs changed
        if: steps.changed.outputs.has_files != 'true'
        run: echo "No changed docs markdown files; skipping local link check."
