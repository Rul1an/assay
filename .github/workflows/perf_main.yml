# Baseline op main + nightly. Bencher slaat resultaten op; PR-workflow vergelijkt.
# Vereist: Repository secrets BENCHER_PROJECT (project slug), BENCHER_API_TOKEN.
# Zie https://bencher.dev/docs/how-to/github-actions/
# Scheduled run (03:00 UTC): full benches; QUICK niet gezet. CI perf-job gebruikt QUICK=1 voor snelle run.
name: Perf (main baseline)

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 3 * * *"  # nightly UTC, full benches

permissions:
  checks: write
  contents: read

jobs:
  benches:
    name: Criterion baseline (main)
    runs-on: ubuntu-latest
    env:
      QUICK: "1"
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Swatinem/rust-cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
      - name: Install Linux deps
        shell: bash
        run: |
          set -euo pipefail
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends clang libsqlite3-dev || {
            sudo DEBIAN_FRONTEND=noninteractive apt-get update -y -o Acquire::Retries=10 -o Acquire::http::Timeout=60 -o Acquire::https::Timeout=60
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends clang libsqlite3-dev
          }
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          components: rustfmt
      - uses: bencherdev/bencher@451ec1124b6d2c5797ac27d9a572233eb308e9d2 # @main
      # stdin/pipe mode: cargo bench output piped to bencher run (no command after --)
      # This is more reliable than exec mode for capturing Criterion output.
      - name: Criterion (store_write_heavy)
        env:
          BENCHER_PROJECT: ${{ secrets.BENCHER_PROJECT }}
          BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$BENCHER_PROJECT" ] || [ -z "$BENCHER_API_TOKEN" ]; then echo "Bencher not configured, skipping."; exit 0; fi
          cargo bench -p assay-core --bench store_write_heavy 2>&1 \
            | grep -v "Gnuplot not found" \
            | bencher run \
                --project "$BENCHER_PROJECT" \
                --token "$BENCHER_API_TOKEN" \
                --branch main \
                --testbed ubuntu-latest \
                --adapter rust_criterion \
                --ci-id store_write_heavy \
                --threshold-measure latency \
                --threshold-test t_test \
                --threshold-max-sample-size 64 \
                --threshold-upper-boundary 0.99 \
                --thresholds-reset \
                --github-actions "$GITHUB_TOKEN"
          test -d target/criterion
          find target/criterion -name estimates.json -print -quit | grep -q .
      - name: Criterion (suite_run_worstcase)
        env:
          BENCHER_PROJECT: ${{ secrets.BENCHER_PROJECT }}
          BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$BENCHER_PROJECT" ] || [ -z "$BENCHER_API_TOKEN" ]; then echo "Bencher not configured, skipping."; exit 0; fi
          cargo bench -p assay-cli --bench suite_run_worstcase 2>&1 \
            | grep -v "Gnuplot not found" \
            | bencher run \
                --project "$BENCHER_PROJECT" \
                --token "$BENCHER_API_TOKEN" \
                --branch main \
                --testbed ubuntu-latest \
                --adapter rust_criterion \
                --ci-id suite_run_worstcase \
                --threshold-measure latency \
                --threshold-test t_test \
                --threshold-max-sample-size 64 \
                --threshold-upper-boundary 0.99 \
                --thresholds-reset \
                --github-actions "$GITHUB_TOKEN"
          test -d target/criterion
          find target/criterion -name estimates.json -print -quit | grep -q .
