# Baseline op main + nightly. Bencher slaat resultaten op; PR-workflow vergelijkt.
# Vereist: Repository secrets BENCHER_PROJECT (project slug), BENCHER_API_TOKEN.
# Zie https://bencher.dev/docs/how-to/github-actions/
# Scheduled run (03:00 UTC): full benches; QUICK niet gezet. CI perf-job gebruikt QUICK=1 voor snelle run.
name: Perf (main baseline)

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 3 * * *"  # nightly UTC, full benches

permissions:
  checks: write
  contents: read

jobs:
  benches:
    name: Criterion baseline (main)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Swatinem/rust-cache
        uses: Swatinem/rust-cache@v2
      - name: Install Linux deps
        shell: bash
        run: |
          set -euo pipefail
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends clang libsqlite3-dev || {
            sudo DEBIAN_FRONTEND=noninteractive apt-get update -y -o Acquire::Retries=10 -o Acquire::http::Timeout=60 -o Acquire::https::Timeout=60
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends clang libsqlite3-dev
          }
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - uses: bencherdev/bencher@main
      # script -q -e -c "..." /dev/null: pseudo-TTY so Criterion prints timing (Bencher parses stdout); -e propagates exit code.
      - name: Criterion (store_write_heavy)
        env:
          BENCHER_PROJECT: ${{ secrets.BENCHER_PROJECT }}
          BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$BENCHER_PROJECT" ] || [ -z "$BENCHER_API_TOKEN" ]; then echo "Bencher not configured, skipping."; exit 0; fi
          bencher run \
            --project "$BENCHER_PROJECT" \
            --token "$BENCHER_API_TOKEN" \
            --branch main \
            --testbed ubuntu-latest \
            --adapter rust_criterion \
            --threshold-measure latency \
            --threshold-test t_test \
            --threshold-max-sample-size 64 \
            --threshold-upper-boundary 0.99 \
            --thresholds-reset \
            --github-actions '${{ secrets.GITHUB_TOKEN }}' \
            -- script -q -e -c "cargo bench -p assay-core --bench store_write_heavy" /dev/null
          test -d target/criterion
          find target/criterion -name estimates.json -print -quit | grep -q .
      - name: Criterion (suite_run_worstcase)
        env:
          BENCHER_PROJECT: ${{ secrets.BENCHER_PROJECT }}
          BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$BENCHER_PROJECT" ] || [ -z "$BENCHER_API_TOKEN" ]; then echo "Bencher not configured, skipping."; exit 0; fi
          bencher run \
            --project "$BENCHER_PROJECT" \
            --token "$BENCHER_API_TOKEN" \
            --branch main \
            --testbed ubuntu-latest \
            --adapter rust_criterion \
            --threshold-measure latency \
            --threshold-test t_test \
            --threshold-max-sample-size 64 \
            --threshold-upper-boundary 0.99 \
            --thresholds-reset \
            --github-actions '${{ secrets.GITHUB_TOKEN }}' \
            -- script -q -e -c "cargo bench -q -p assay-cli --bench suite_run_worstcase" /dev/null
          test -d target/criterion
          find target/criterion -name estimates.json -print -quit | grep -q .
