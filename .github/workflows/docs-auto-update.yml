name: Auto-Update Docs

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**.md"
      - ".github/workflows/docs-auto-update.yml"
  workflow_dispatch:
    inputs:
      force_update:
        description: "Force update even if no code changes"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-docs:
    name: Generate Docs & Diagrams
    runs-on: ubuntu-latest
    # Only run on main repo, not forks
    if: github.repository == 'Rul1an/assay'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0 # Full history for changelog

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Generate crate dependency diagram
        run: |
          chmod +x scripts/docs/generate-crate-deps.sh
          scripts/docs/generate-crate-deps.sh

      - name: Generate module map
        run: |
          chmod +x scripts/docs/generate-module-map.sh
          scripts/docs/generate-module-map.sh

      - name: Update architecture diagrams
        run: |
          chmod +x scripts/docs/update-architecture-docs.sh
          scripts/docs/update-architecture-docs.sh

      - name: Update changelog (from recent PRs)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/docs/update-changelog.sh
          scripts/docs/update-changelog.sh

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet docs/; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: auto-update diagrams and crate info"
          title: "docs: auto-update diagrams and crate info"
          body: |
            ## Automated Documentation Update

            This PR was automatically generated after a merge to main.

            ### Changes
            - Updated crate dependency diagram
            - Updated module structure map
            - Updated version info in code-map.md
            - Added changelog entries for recent PRs

            ---
            *Generated by [docs-auto-update.yml](.github/workflows/docs-auto-update.yml)*
          branch: docs/auto-update
          delete-branch: true
          labels: documentation,automated
