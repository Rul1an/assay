name: Perf Nightly (forensic trend)

on:
  schedule:
    # Run at 03:00 UTC daily (off-peak)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Forensic iterations per workload'
        required: false
        default: '30'

env:
  CARGO_TERM_COLOR: always

jobs:
  forensic:
    name: Nightly forensic trend
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: Swatinem/rust-cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Install Linux deps
        run: |
          sudo apt-get update -o Acquire::Retries=3 -o Acquire::http::Timeout=30
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends clang libsqlite3-dev bc jq

      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - uses: bencherdev/bencher@451ec1124b6d2c5797ac27d9a572233eb308e9d2 # @main

      - name: Build release binary
        run: cargo build --release -p assay-cli

      - name: Run forensic assessment
        id: forensic
        env:
          ASSAY: ./target/release/assay
          FORENSIC: "1"
          FORENSIC_ITERATIONS: ${{ github.event.inputs.iterations || '30' }}
        run: |
          # Run forensic mode and capture output
          ./scripts/perf_assess.sh 2>&1 | tee forensic_output.txt

          # Extract key metrics for job summary
          {
            echo "## Nightly Forensic Results"
            echo ""
            echo "### worst_file_backed"
            grep -A15 "Forensic: worst_file_backed" forensic_output.txt | grep -E "(median|p95|p99|tail_ratio|status)" || true
            echo ""
            echo "### Store metrics"
            grep -A5 "Store metrics:" forensic_output.txt | head -6 || true
          } >> "$GITHUB_STEP_SUMMARY"

          # Check for failures
          if grep -q "❌ FAIL" forensic_output.txt; then
            echo "::warning::Forensic detected threshold violations"
            echo "forensic_status=fail" >> "$GITHUB_OUTPUT"
          elif grep -q "⚠️" forensic_output.txt; then
            echo "forensic_status=warn" >> "$GITHUB_OUTPUT"
          else
            echo "forensic_status=pass" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate BMF JSON for Bencher
        env:
          ASSAY: ./target/release/assay
          FORENSIC: "1"
          BMF_JSON: "1"
        run: |
          # Re-run with BMF_JSON to get Bencher-compatible output
          # (forensic data is cached in temp, this just extracts the JSON)
          ./scripts/perf_assess.sh 2>/dev/null | tail -20 > forensic_bmf.json || true
          cat forensic_bmf.json

      - name: Push forensic metrics to Bencher
        env:
          BENCHER_PROJECT: ${{ secrets.BENCHER_PROJECT }}
          BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Push forensic metrics as custom measures
          # Thresholds: tail_ratio > 2.0 = fail, sqlite_busy_count > 0 = warn
          if [ -z "$BENCHER_PROJECT" ] || [ -z "$BENCHER_API_TOKEN" ]; then
            echo "Bencher not configured, skipping push"
            exit 0
          fi
          if [ -s forensic_bmf.json ]; then
            bencher run \
              --project "$BENCHER_PROJECT" \
              --token "$BENCHER_API_TOKEN" \
              --branch main \
              --testbed ubuntu-latest \
              --adapter json \
              --threshold-measure tail_ratio \
              --threshold-test static \
              --threshold-upper-boundary 2.0 \
              --github-actions "$GITHUB_TOKEN" \
              --file forensic_bmf.json || echo "Bencher push failed (non-fatal)"
          else
            echo "No BMF JSON generated, skipping Bencher push"
          fi

      - name: Upload forensic artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: forensic-${{ github.run_number }}
          path: |
            forensic_output.txt
            forensic_bmf.json
          retention-days: 90

      - name: Trend summary
        run: |
          {
            echo "## Trend Analysis"
            echo ""
            echo "Status: ${{ steps.forensic.outputs.forensic_status }}"
            echo ""
            echo "View historical artifacts to track trends over time."
            echo ""
            echo "Bencher dashboard: https://bencher.dev/perf/${{ secrets.BENCHER_PROJECT }}"
          } >> "$GITHUB_STEP_SUMMARY"
