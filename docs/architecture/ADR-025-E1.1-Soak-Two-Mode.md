# ADR-025-E1.1: Soak Two-Mode — artifact vs run (2026-aligned)

**Status:** Proposed (Feb 2026)
**Supersedes / extends:** E1 Soak MVP
**Context:** [On Randomness in Agentic Evals](https://arxiv.org/abs/2502.06685), ReliabilityBench, τ-bench — "soak" + "pass^k" triggers 2026-expectation van variance/drift, niet "herhaal lint opzelfde artifact".

---

## Problem

E1 implementeert `assay sim soak --target bundle.tar.gz --iterations N`: N× lint op **exact hetzelfde** bundle.

- **Waarde:** policy determinism, report plumbing, stability van verify pipeline.
- **Gap:** 2026-soak = herhaalde *trajectories* (run variance), niet herhaalde verificaties van één output.
- **Risico:** term "soak" + "pass^k" wekt verwachting van drift/variance; users verwachten ReliabilityBench-achtig oppervlak R(k, ε, λ).

---

## Decision

Introduceer **twee modes** met eerlijke naming:

| Mode | Variatiebron | Use case |
|------|--------------|----------|
| **artifact** | Geen — N× lint op zelfde bundle | Policy determinism, report stability, flaky-infra detect |
| **run** | N× bundle genereren (run-cmd) | Echte drift/variance, pass^k under randomness |

### CLI shape

```bash
# artifact-mode (huidig E1; default tot run-mode klaar is)
assay sim soak --mode=artifact --target bundle.tar.gz --iterations 20

# run-mode (toekomstige default; stub nu)
assay sim soak --mode=run --run-cmd "./ci/run_agent_and_export_bundle.sh" \
  --iterations 50 --seed 42 --seed-strategy per-iteration
```

### UX / Honest positioning

- **artifact-mode:**
  "Note: --mode=artifact repeats lint on a fixed bundle. This measures policy determinism/report stability, not agent variance/drift. Use --mode=run --run-cmd <cmd> for pass^k under variance." Suppress with `--quiet`.
- **Help:**
  "Soak (artifact)" vs "Soak (run)" — één zin verschil.
- **Report:**
  `variation_source`: `"deterministic_repeat"` (artifact) vs `"run_trajectories"` (run).

---

## Report & Contract Extensions

### variation_source (bestaand, uitbreiden)

| Value | Betekenis |
|-------|-----------|
| `deterministic_repeat` | artifact-mode; N× zelfde input |
| `run_trajectories` | run-mode; N× nieuwe bundle per iteratie |
| `seed_sweep` | run-mode + per-iteration seed (toekomst) |

### pass^k semantiek (hard maken)

- `pass_rate` = passes / N (punt-estimate)
- `pass_all` = alle N runs pass (effectief pass^N)
- **Nieuw (E1.1):** `pass_pow_k` — gekozen k (bv. 10) voor "stability at k" gate
- **Toekomst:** confidence band (Wilson/Jeffreys) i.p.v. alleen punt-estimate

### Seed sweep (E1.1 baseline)

- `--seed-strategy fixed|per-iteration|list`
- Report: per-run seed; aggregaties
- MVP: fixed (huidig) + per-iteration (nieuw)

---

## Implementation Phases

### Phase 1 (E1.1 — implemented)

1. **--mode artifact|run**
   - artifact = huidig gedrag (default)
   - run = placeholder: "--mode=run is not implemented yet (E1.1)... Track: ADR-025 E1.2"

2. **UX warning in artifact-mode**
   - Eén regel: "Note: fixed bundle; measures policy determinism. Use --mode=run for drift."

3. **Report:**
   - `soak_mode` in report = "artifact" | "run" (naast bestaande `mode: "soak"`)
   - `variation_source` blijft; run-mode krijgt later `run_trajectories`

4. **Backwards compat**
   - Geen `--mode` = artifact (default)
   - `--target` required in artifact (clap required_if_eq + runtime fallback)
   - `--run-cmd` required in run (clap required_if_eq)
   - `--target` en `--run-cmd` mutueel exclusief (clap conflicts_with)
   - `--quiet` suppresses artifact warning (CI)

### Phase 2 (run-mode MVP)

1. `--run-cmd` subprocess N×
2. `--seed-strategy per-iteration` → seed(i) = base_seed + i
3. Per iteratie: run cmd → bundle path → lint → aggregate
4. `pass_pow_k` in report (k configurable)

### Phase 3 (fault profiles, λ)

1. Tool-proxy / MCP gateway shim voor fault injection
2. Profielen: rate_limit, timeout, schema_drift, truncation
3. `--fault-profile none|light|path/to/profile.yaml`

### Phase 4 (ε perturbaties)

1. `--perturb none|light|profile:<file>`
2. Semantische perturbaties; later

---

## Acceptance (E1.1 patch)

- [x] `--mode artifact` (default) = huidig gedrag
- [x] `--mode run` = exit met "run-mode not yet implemented"
- [x] Artifact-mode print warning: fixed bundle, policy determinism
- [x] Report bevat `soak_mode` (artifact|run)
- [x] CLI help: "Soak (artifact)" / "Soak (run)" uitleg

---

## References

- On Randomness in Agentic Evals (multi-run, power analysis, pass^k)
- ReliabilityBench: R(k, ε, λ) surface
- τ-bench: pass^k as pessimistic consistency measure
- Variance 2–6pp pass@1 across runs (materieel)
