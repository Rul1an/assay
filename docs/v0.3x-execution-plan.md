# Assay v0.3.x Implementatieplan

**Doel:** Van "evaluation engine" naar "workflow product": frictionless adoption, trace/dataset lifecycle, en data-gedreven calibratie.

## Dependency Graph

1.  **v0.3.0 tagged** (Done)
2.  **v0.3.1 Adoption Release** (Done)
    *   `PR-3.1.1` Release workflow (binaries + checksums)
    *   `PR-3.1.2` assay-action golden path
    *   `PR-3.1.3` Examples pack
3.  **v0.3.2 Dataset & Trace Lifecycle**
    *   `PR-3.2.1` Trace core (ingest/verify)
    *   `PR-3.2.2` Precompute (embeddings + judge)
    *   `PR-3.2.3` Strict replay guardrail
4.  **v0.3.3 Calibration & Hygiene**
    *   `PR-3.3.1` Calibrate
    *   `PR-3.3.2` Baseline hygiene report

---

## Failure Modes & Mitigations

| Failure Mode / Issue | Mitigatie | Release |
| :--- | :--- | :--- |
| **"Action werkt niet in clean repo"** (geen Rust toolchain) | prebuilt binaries + action download | v0.3.1 |
| **Trace misses / prompt mismatch** | `assay trace verify` + coverage checks | v0.3.2 |
| **Baseline churn** (te vaak updates) | hygiene report + fingerprint drift insights | v0.3.3 |
| **Slow CI** (alles rerun) | incremental execution + caching contract | v0.3.0/0.3.1 |
| **Flaky judge/semantic** (variance) | strict replay + precompute + rerun model | v0.3.2 |
| **Onbedoeld live netwerk in CI** | `--replay-strict` hard fail | v0.3.2 |
| **"Waarom threshold 0.85?"** | `assay calibrate` + percentiles + aanbevelingen | v0.3.3 |
| **Embeddings/judge kosten lopen op** | batch precompute + offline CI | v0.3.2 |
| **Multi-team config drift** (suite/versie mismatch) | baseline schema hardening + fingerprint warnings | v0.2.1/0.3.x |
| **Debuggability** (waarom skip/fail?) | `--explain-skip`, `run.json` details, CI contracts | v0.3.0+ |

---

## Phase 1 — v0.3.1 “Adoption Release” (Completed)

**Goal:** "No Rust toolchain needed"

### PR-3.1.1 Release workflow (binaries & SHA256SUMS)
*   **Scope:** `.github/workflows/release.yml` building on tag `v*`.
*   **Artifacts:** `assay-linux-x86_64.tar.gz`, `assay-macos-x86_64.tar.gz`, `assay-macos-aarch64.tar.gz`, `SHA256SUMS`.
*   **Acceptance:** Assets visible on GitHub Releases, valid checksums.

### PR-3.1.2 assay-action “Golden Path”
*   **Goal:** First-class Action support.
*   **Inputs:** `baseline`, `export_baseline`, `cache_mode`, `extra_args`.
*   **Caching:** Smarts for `.eval/` directory.

### PR-3.1.3 Examples onboarding pack
*   **Goal:** "15-min zero-to-gate".
*   **Pack:** `rag-grounding`, `negation-safety`, `baseline-gate`.

---

## Phase 2 — v0.3.2 Trace Lifecycle (± 2 weeks)

**Goal:** Enable "Offline CI" by making traces first-class datasets.

### PR-3.2.1 Trace core: ingest + verify
*   **CLI:**
    *   `assay trace ingest --input logs/*.jsonl --output dataset.jsonl`
    *   `assay trace verify --trace dataset.jsonl --config eval.yaml`
*   **Implementation:** `crates/assay-core/src/trace/{mod,schema,ingest,verify}.rs`.
*   **Schema:** `TraceEntryV1` (standardized structure).

### PR-3.2.2 Precompute: embeddings + judge
*   **CLI:**
    *   `assay trace precompute-embeddings --trace dataset.jsonl --embedder openai`
    *   `assay trace precompute-judge --trace dataset.jsonl --judge openai`
*   **Contract:** Writes to `meta.assay.embeddings` and `meta.assay.judge`. Runner reads these before making live calls.

### PR-3.2.3 Strict replay guardrail
*   **Flag:** `--replay-strict`.
*   **Behavior:** Exit 2 if embedder/judge/LLM needs to make a live call.
*   **CI:** Enforced in CI templates for Offline Mode.

---

## Phase 3 — v0.3.3 Calibration & Hygiene (± 1 week)

**Goal:** Data-driven confidence.

### PR-3.3.1 assay calibrate
*   **Input:** `--run run.json` (or DB).
*   **Output:** `calibration.json` + Markdown summary (percentiles, suggested thresholds).
*   **Implementation:** `crates/assay-core/src/calibration/`.

### PR-3.3.2 Baseline hygiene report
*   **Goal:** Identify "baseline churn" and instability.
*   **Metrics:** Fingerprint mismatch rate, drift frequency, judge variance.

---

## CI Acceptance Contracts

New workflow: `.github/workflows/acceptance.yml`

*   **fresh-install:** Runs `rag-grounding` with `v0.3.1` action.
*   **baseline-export:** Runs `baseline-gate` and verifies export.
*   **strict-replay-fails:** Intentionally runs with incomplete trace + `--replay-strict` and asserts exit code 2.

---

## Repo Skeleton (Target State v0.3.3)

```text
crates/
  assay-cli/
    src/cli/
      args.rs
      commands/
        mod.rs
        trace.rs          # v0.3.2
        calibrate.rs      # v0.3.3
        baseline.rs       # v0.3.3 extend
  assay-core/
    src/
      trace/             # v0.3.2
        mod.rs
        schema.rs
        ingest.rs
        verify.rs
        precompute.rs
      calibration/       # v0.3.3
        mod.rs
        stats.rs
        recommendations.rs
      baseline/
        report.rs        # v0.3.3
assay-action/
  action.yml
  README.md
.github/workflows/
  release.yml            # v0.3.1
  acceptance.yml         # v0.3.1+
examples/
  README.md
  rag-grounding/
  negation-safety/
  baseline-gate/
docs/
  user-guide.md
  v0.3x-execution-plan.md
```

---

## Priorities

**P0 (Adoption Blockers) - DONE**
1.  Release workflow.
2.  Assay Action Golden Path.
3.  Examples Pack.

**P1 (Offline CI & Lifecycle)**
4.  `assay trace` (ingest/verify).
5.  Precompute (embeddings + judge).
6.  `--replay-strict`.

**P2 (Confidence & UX)**
7.  `assay calibrate`.
8.  Baseline hygiene report.
